name: Push to Aliyun Docker Registry

on:
  push:
    branches:
      - main  # 触发条件：在 main 分支推送时执行

jobs:
  push_to_aliyun:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Login to Aliyun Docker Registry
        run: echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login -u "${{ secrets.ALIYUN_REGISTRY_USER }}" --password-stdin "${{ secrets.ALIYUN_REGISTRY_URL }}"

      - name: Pull and Push Docker Images
        run: |
          # Nginx
          docker pull nginx:latest
          docker tag nginx:latest "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/nginx:latest"
          docker push "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/nginx:latest"

          # MySQL
          docker pull mysql:latest
          docker tag mysql:latest "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/mysql:latest"
          docker push "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/mysql:latest"

          # Redis
          docker pull redis:latest
          docker tag redis:latest "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/redis:latest"
          docker push "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/redis:latest"

          # RabbitMQ
          docker pull rabbitmq:latest
          docker tag rabbitmq:latest "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/rabbitmq:latest"
          docker push "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/rabbitmq:latest"

          # Elasticsearch
          docker pull elasticsearch:latest
          docker tag elasticsearch:latest "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/elasticsearch:latest"
          docker push "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/elasticsearch:latest"

          # Maxwell
          docker pull zendesk/maxwell:latest
          docker tag zendesk/maxwell:latest "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/maxwell:latest"
          docker push "${{ secrets.ALIYUN_REGISTRY_URL }}/tyyfhju-images/maxwell:latest"

        env:
          DOCKER_CLI_EXPERIMENTAL: enabled
